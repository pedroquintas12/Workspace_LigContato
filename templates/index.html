<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
    <script>
        let userRole = ""; // Será definido pelo backend ao carregar a página.

        document.addEventListener("DOMContentLoaded", function () {
            const tableBody = document.getElementById("stream-table-body");
            const closeShiftButton = document.getElementById("close-shift-btn");

            // Função para converter a data de dd/MM/yyyy HH:mm:ss para o formato ISO 8601
            function convertToISOFormat(dateString) {
                const [day, month, year, hour, minute, second] = dateString.split(/[\s\/:]/);
                return `${year}-${month}-${day}T${hour}:${minute}:${second}`;
            }

            // Função para garantir que a data seja convertida para o formato correto
            function parseDate(dateString) {
                // Converte a data para o formato ISO
                const isoDate = convertToISOFormat(dateString);
                const parsedDate = new Date(isoDate);
                if (isNaN(parsedDate.getTime())) {
                    return null; // Retorna null se a data for inválida
                }
                return parsedDate;
            }

            // Função para calcular o tempo decorrido
            function calculateElapsedTime(startTime) {
                const start = parseDate(startTime);
                const now = new Date();

                if (!start) {
                    return "Tempo inválido";
                }

                const elapsedMs = now - start;

                if (elapsedMs < 0) {
                    return "Tempo inválido";
                }

                const elapsedMinutes = Math.floor(elapsedMs / 60000);
                const elapsedSeconds = Math.floor((elapsedMs % 60000) / 1000);

                return `${elapsedMinutes}m ${elapsedSeconds}s`;
            }

            // Configurar SSE
            const eventSource = new EventSource("/api/actions/stream");

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    // Limpa a tabela antes de preencher novamente
                    tableBody.innerHTML = "";

                    data.forEach(action => {
                        const elapsedTime = action.fim ? "-" : calculateElapsedTime(action.inicio);
                        const status = action.fim ? action.fim : "Em andamento";

                        const row = `
                            <tr>
                                <td>${action.username}</td>
                                <td>${action.estado}</td>
                                <td>${action.diario}</td>
                                <td>${action.status}</td>
                                <td>${action.inicio}</td>
                                <td>${status}</td>
                                <td>${elapsedTime}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Erro ao processar dados do SSE:", error);
                }
            };

            // Bloqueia alterações para usuários FUNC
            if (userRole === "FUNC") {
                closeShiftButton.classList.add("disabled");
            }

            // Fechar turno
            closeShiftButton.addEventListener("click", function () {
                if (!closeShiftButton.classList.contains("disabled")) {
                    fetch("/api/actions/finalizar", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ status: "F" })
                    })
                        .then(response => response.json())
                        .then(data => alert(data.message))
                        .catch(error => console.error("Erro ao fechar turno:", error));
                }
            });
        });
    </script>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Stream Monitor</h1>

        <div class="mb-3 text-end">
            <button id="close-shift-btn" class="btn btn-danger">Fechar Turno</button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Usuário</th>
                        <th>Estado</th>
                        <th>Diário</th>
                        <th>Status</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Tempo Decorrido</th>
                    </tr>
                </thead>
                <tbody id="stream-table-body">
                    <!-- Dados carregados em tempo real -->
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>
